<script>
import axios from 'axios';
import {store} from '../Store';
import Plate from '../components/Plate.vue';
import Cart from '../components/Cart.vue'

export default {
        name: "SingleRestaurant",
        components:{
            Plate,
            Cart,
        },
        data(){
            return{
                store,
                plates: [],
                restaurant: [],
                storedArray:"",
                arrayString:"",
                storedArray:"",
                parsedArray:[],
                controllo:false,
                ArrayPrimi: [],
                ArraySecondi: [],
                ArrayDessert: [],
                ArrayBevande: [],
                ContolloRistorante:[],
                Sospeso:"false"
            }
        },
        methods:{
            getPlates(){
                axios.get(`http://127.0.0.1:8000/api/restaurant/${this.$route.params.slug}`).then((res)=> { 
                    this.plates = res.data.dishes
                    this.restaurant = res.data.restaurant
                    this.dishSorterer();
                    console.log(this.plates, this.restaurant)
                } )
            },

            addplate(plate){
                
                // controllo se esiste la chiave nel local storage, se non c e pusho il piatto
                this.ContolloRistorante=Object.keys(localStorage)
                this.Sospeso = false
                this.ContolloRistorante.forEach(element => {
                    if(element.includes("restaurant") && (element != "restaurant"+this.restaurant.id)){
                        //se è presente una chiave che contiene la parola restaurant e non corrisponde con la chiave del ristorante attuale 
                       this.Sospeso = true
                    }
                });

                

                if(localStorage.getItem("restaurant"+this.restaurant.id) == null && this.Sospeso!=true){
                    // se non esistono chiavi con lo stesso id del ristoratne attuale e non ci sono ordini in sospeso posso aggiungere il piatto
                    this.parsedArray.push(plate)
                    this.arrayString=JSON.stringify(this.parsedArray)
                    localStorage.setItem("restaurant" + this.restaurant.id, this.arrayString)
                    
                }else{
                    if(this.Sospeso==false){

                        // se gia esiste un ristorante devo controllare se è gia incluso il piatto

                        this.storedArray = localStorage.getItem("restaurant" + this.restaurant.id)
                        this.parsedArray = JSON.parse(this.storedArray)

                        this.controllo=false

                        // ciclo che controlla i singoli id in local con l id del piatto cliccato

                        this.parsedArray.forEach(element => {
                            
                            if(element.id == plate.id){
                                this.controllo=true
                            }
                        });
                        
                        // se la variabile controllo è false allora quel piatto è gia presente

                        if(!this.controllo){
                        
                            this.parsedArray.push(plate)
                            this.arrayString=JSON.stringify(this.parsedArray)
                            localStorage.setItem("restaurant" + this.restaurant.id, this.arrayString) 

                        }else{
                            console.log("piatto gia aggiunto")

                        }
                    }else{
                        console.log("hai gia un ordine in sospeso")
                    }
                }
   
            
            },
            log(){
                this.storedArray = localStorage.getItem(this.restaurant.id)

                // Convertire la stringa JSON in un array
                this.parsedArray = JSON.parse(this.storedArray)

                // Utilizzare l'array recuperato
            
                    
                console.log(this.parsedArray)

            },
            dishSorterer(){
                this.plates.forEach(plate => {
                    if(plate.category_id == 1){
                        this.ArrayPrimi.push(plate);
                    } else if(plate.category_id == 2){
                        this.ArraySecondi.push(plate);
                    } else if(plate.category_id == 3){
                        this.ArrayDessert.push(plate);
                    } else if(plate.category_id == 4){
                        this.ArrayBevande.push(plate);
                    }
                });
            },


            setRestaurantImage(restaurant_image){
                let image = '';
                switch (true) {
                    case restaurant_image == undefined:
                      return  image = '/img/deliveboo-logo.png';
                    case restaurant_image.includes('restaurant_images/'):
                    return image =  `http://127.0.0.1:8000/storage/${restaurant_image}`;
                }
            }
        },
        mounted(){
            this.getPlates();
        },
    }
</script>

<template>
    <div class="main-bg-color">
        <!-- top restaurant banner -->
        <div class="bg-restaurant-template">
            <div class="container h-100">
                <div class="row justify-content-center align-items-end h-100">
                    <div class="col-12">
                        <div class="translate-middle-min-y">
                            <div class="restaurant-banner-info p-4 rounded-3 text-center position-relative">
                                <figure class="position-absolute restaurant-figure-position">
                                    <img class="border-image rounded-3" :class="(!restaurant.image? 'restaurant-image-template' : 'restaurant-image' )" :src="setRestaurantImage(restaurant.image)" alt="restaurant-image">
                                </figure>                                
                                <div class="mt-5">
                                    <h1>{{ restaurant.activity_name }}</h1>
                                    <p>{{ restaurant.address }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
     <!-- <img src="../assets/img/add-to-cart.png" alt="add-to-cart" class="add-to-cart"> -->
        <div class="container pb-5 custom-top-padding">
            <!-- Primi piatti -->
            <div v-if="this.ArrayPrimi.length > 0" class="mb-4">
                <h2>Primi</h2>
                <div class="container">
                    <div class="row row-gap-3">
                        <div class="col-12 col-md-6 col-lg-4" v-for="(plate, index) in this.ArrayPrimi" :key="plate.id">
                            <Plate @click="addplate(plate)" :plate = plate />
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Secondi piatti -->
            <div v-if="this.ArraySecondi.length > 0" class="mb-4">
                <h2>Secondi</h2>
                <div class="container">
                    <div class="row row-gap-3 ">
                        <div class="col-12 col-md-6 col-lg-4" v-for="(plate, index) in this.ArraySecondi" :key="plate.id">
                            <Plate @click="addplate(plate)" :plate = plate />
                        </div>
                    </div>
                </div>
            </div>
            <!-- Dessert -->
            <div v-if="this.ArrayDessert.length > 0" class="mb-4">
                <h2>Dessert</h2>
                <div class="container">
                    <div class="row row-gap-3">
                        <div class="col-12 col-md-6 col-lg-4" v-for="(plate, index) in this.ArrayDessert" :key="plate.id">
                            <Plate @click="addplate(plate)" :plate = plate />
                        </div>
                    </div>
                </div>
            </div>
            <!-- bevande -->
            <div v-if="this.ArrayBevande.length > 0">
                <h2>Bevande</h2>
                <div class="container">
                    <div class="row row-gap-3">
                        <div class="col-12 col-md-6 col-lg-4" v-for="(plate, index) in this.ArrayBevande" :key="plate.id">
                            <Plate @click="addplate(plate)" :plate = plate />
                        </div>
                    </div>
                </div>
            </div>
        </div>        
    </div>
    
<Cart/>
</template>


<style lang="scss" scoped>
@use '../assets/sass/partials/variables' as *;
    h2{
        color: white;
    }
    .bg-restaurant-template{
        background-image: url('/img/template-img.png');
        height: 200px;
        background-size: 140px;
    }
    .translate-middle-min-y{
        transform: translateY(40%)
    }
    .custom-top-padding{
        padding-top: 6em;
    }

    .restaurant-banner-info{
        background-color: #03071e;
        color: white;
        h1{
            color: $dark-yellow;
        }
        p{
            color: $orange;
        }
    }
    .restaurant-image{
        width: 200px;
        height: 130px;
        
        object-fit: cover;
        object-position: center
    }
    .restaurant-image-template{
        width: 200px;
        height: 130px;
        
        object-fit: contain;
        background-color:black;
    }

    .restaurant-figure-position{
        top: 0;
        left: 50%;
        transform: translate(-50%,-50%);
    }
    .border-image{
        border: 5px solid #e47400;
        box-shadow: 0px 10px 50px 25px #e4760036;
    }

    .main-bg-color{
        background-color: $peacoat;
    }

</style>